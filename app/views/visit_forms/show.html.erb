<div class="content">

  <h1 class = "show-title"><%= @visit_form.title %></h1>
  <div class="card-show-title ">
    <%= link_to user_path(@visit_form.user), class: "nav-link" do%>
    <h5><%= @visit_form.user.first_name.capitalize %> <%= @visit_form.user.last_name.capitalize %></h5>
      <hr>
      <% if @visit_form.user.photo.attached? %>
        <%= cl_image_tag @visit_form.user.photo.key, class: "avatar-show" %>
      <% else %>
        <img class="avatar-show" src="https://res.cloudinary.com/dhvssfzz1/image/upload/v1693474293/avatar-_mtc5tf.jpg" alt="">
      <% end%>
    <%end%>
    <b>Localisation du bien:</b><h5><%= @visit_form.address %></h5>

    <p><b>Nombre de pièces:</b> <span class="rooms-number"><%= @visit_form.rooms_number %></span></p>
    <p class="truncate-text"><a href="<%= @visit_form.url %>" target="_blank">Lien vers l'annonce</a></p>
    <%if @visit_form.description.present?%>
      <p>Description du bien: <%= @visit_form.description %></p>
    <%end%>

  </div>

    <%if @visit_form.description.present?%>
      <div class="card-show-critere">
        <p><b>Description du bien:</b> <%= @visit_form.description %></p>
      </div>
    <%end%>

    <div class="mt-4"><h3>Critères à vérifier:</h3></div>
      <% if @visit_form.criteres.present?%>
        <% @visit_form.criteres.each do |critere|%>
          <% if critere.question.present? && critere.answer.present?%>
            <div class="card-show-critere">
              <p><b>Critère:</b> <%= critere.question %></p>
              <p><b>Réponse:</b> <%= critere.answer %></p>
              <% critere.photos.each do |photo| %>
              <%= image_tag photo, class: "rooms-photos"%>
              <% end %>
            </div>
          <%elsif critere.question.present?%>
            <div class="card-show-critere">
              <p><b>Critère:</b> <%= critere.question %></p>
            </div>
          <%end%>
        <%end%>
    <%else%>
        <p><%= @visit_form.user.first_name.capitalize %> n'a pas précisé de critères à verifier</p>
    <%end%>


  <% @visit_form.rooms.each do |room|%>
    <% if room.name.present? || room.description.present? %>
      <div class="card-show-title">
        <b><%= room.name %></b>
        <p><%= room.description %></p>
        <% room.photos.each do |photo| %>
        <%= image_tag photo, class: "rooms-photos"%>
        <% end %>
      </div>
    <%end%>
  <%end%>


  <div class="margin-div">
    <% if current_user == @visit_form.user && @visit_form.bookings.exists?(visit_form_id: @visit_form.id) == false %>
      <%=link_to "Supprimer la visite", visit_form_path(@visit_form), data: {turbo_method: :delete, turbo_confirm: "Etes vous sûr de vouloir supprimer cette visite" }, class:"btn button-supprimer"%>
    <%elsif current_user.bookings.exists?(visit_form_id: @visit_form.id) %>
      <% @visit_form.bookings.each do |booking| %>
        <% if booking.status == "validé" %>
          <%= link_to "Editer mon compte-rendu", edit_visit_form_path(@visit_form), class: "btn button-reserver" %>
          <%= link_to "Envoyer le compte-rendu", booking_ended_path(booking), data: { turbo_method: :patch, turbo_confirm: "Etes vous sûr de vouloir finaliser cette réservation, vous ne pourez plus la modifier ?" }, class: "btn btn button-terminer" %>
        <%elsif booking.status == "en attente de validation"%>
          <div class="btn button-reserver">En attente</div>
        <%elsif booking.status == "terminée"%>
        <div class="btn button-reserver">Votre rapport de visite a été envoyé</div>
        <%else%>
          <div class="btn button-reserver">Rejeté</div>
        <%end%>
      <%end%>
    <% elsif  current_user == @visit_form.user && @visit_form.bookings.exists?(visit_form_id: @visit_form.id) %>
      <div class="btn button-reserver">Votre visite a été réservée</div>
    <% else %>
      <%=link_to "Réserver la visite", visit_form_bookings_path(@visit_form), data: {turbo_method: :post, turbo_confirm: "Etes vous sûr de vouloir réserver cette formation?" }, class:"btn button-reserver"%>
    <%end%>
  </div>

  <div style="width: 100%; height: 350px; border-radius: 7px;"
    data-controller="map"
    data-map-markers-value="<%= [@marker].to_json %>"
    data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
  </div>
</div>
