
<div class="content control-content">


  <div class="visites">
    <h2>Mes demandes de visites</h2>
    <%if current_user.visit_forms.empty? %>
        <div class="empty"><p><i> Vous ne proposez aucune visite pour le moment</i></p></div>
        <div><%= link_to "Ajouter une visite", new_visit_form_path, class: "btn button-reserver" %>
    <%else%>
      <% sorted_forms = current_user.visit_forms.sort_by do |visit_form| %>
        <% [visit_form.bookings.any? { |booking| booking.status == "en attente de validation" } ? 0 : 1, visit_form.bookings.empty? ? 0 : 1, visit_form.bookings.any? { |booking| booking.status != "en attente de validation" } ? 0 : 1, visit_form.title] %>
      <% end %>

      <% sorted_forms.each do |visit_form| %>
        <%= link_to visit_form_path(visit_form), class: "text-decoration-none" do %>
          <div class="card-control">
            <h3 class="text-dark"><%= truncate(visit_form.title, length: 28, omission: '...') %></h3>
            <% visit_form.bookings.each do |booking| %>
              <% if booking.status == "en attente de validation" %>
                <%= link_to user_path(booking.user), class: "nav-link" do%>
                  <p class="text-muted"><b>Visite réservée par : <%= booking.user.first_name.capitalize %></b></p>
                <% end%>
                <p class="text-muted"><i><%= booking.status %></i></p>
                <p><%=link_to "Accepter la réservation", booking_accept_path(booking), data: {turbo_method: :patch, turbo_confirm: "Etes vous sûr de vouloir accepter cette réservation?" }, class:"btn btn-accept text-decoration-none"%></p>
                <p><%=link_to "Rejeter la réservation", booking_reject_path(booking), data: {turbo_method: :patch, turbo_confirm: "Etes vous sûr de vouloir rejeter cette réservation?" }, class:"btn btn-reject text-decoration-none"%></p>
              <% end %>
            <% end %>

            <% if visit_form.bookings.none? { |booking| booking.status == "en attente de validation" } %>
              <% if visit_form.bookings.empty? %>
                <p class="text-muted"><i>Aucune réservation pour le moment</i></p>
              <% else %>
                <% visit_form.bookings.each do |booking| %>
                  <% if booking.status != "en attente de validation" %>
                    <%= link_to user_path(booking.user), class: "nav-link" do %>
                      <p class="text-muted"><b>Visite réservée par : <%= booking.user.first_name.capitalize %></b></p>
                    <% end %>
                    <p class="text-muted"><i><%= booking.status %></i></p>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          </div>
        <% end %>
      <% end %>

    <%end%>
  </div>

  <div class="visites">
    <h2>Mes visites prévues</h2>
    <%if current_user.bookings.empty? %>
      <div class="empty"><i> Vous n'êtes inscrit à aucune visite pour le moment</i></div>
    <div><%= link_to "Trouver une visite", visit_forms_path, class: "btn button-reserver" %></div>

    <%else%>
        <%current_user.bookings.each do |booking|%>
          <%= link_to visit_form_path(booking.visit_form), class:" text-decoration-none" do %>
            <div class="card-control">
              <h3 class="text-dark"><%= truncate(booking.visit_form.title, length: 18, omission: '...') %></h3>
              <p class="text-muted"><%= booking.visit_form.user.first_name.capitalize %></p>
              <p class="text-muted"><i><%= booking.status %></i></p>
              <div class="btn-flex"><%=link_to "Supprimer cette réservation", booking_path(booking), data: {turbo_method: :delete, turbo_confirm: "Etes vous sûr de vouloir supprimer cette réservation?" }, class: "btn btn-delete"%></div>
            </div>
          <%end%>
        <%end%>
    <%end%>
  </div>
</div>
